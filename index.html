<!DOCTYPE html>
<html lang="en">
  <head>
    <base target="_top" />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Quick Start - Leaflet</title>

    <link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>

    <style>
      html,
      body {
        height: 100%;
        margin: 0;
      }

      .leaflet-container {
        height: 100%;
        width: 100%;
        max-width: 100%;
        max-height: 100%;
      }
    </style>
  </head>

  <body>
    <div id="map" style="width: 100%; height: 100%"></div>
  </body>
</html>
<script>
  const map = L.map("map").setView([51.505, -0.09], 13);
  const osmUrl = "https://tile.openstreetmap.org/{z}/{x}/{y}.png";
  const osmAttribution = '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>';
  const tilesOptions = { maxZoom: 19, attribution: osmAttribution };
  const tiles = L.tileLayer(osmUrl, tilesOptions).addTo(map);
  const apiUrl = "https://prices.openfoodfacts.org";

  const fetchLocationsPage = page => fetch(`${apiUrl}/api/v1/locations?page=${page}&size=100`).then(response => response.json());
  const saveLocationsToStorage = locs => locs.forEach(loc => localStorage.setItem(loc.id, JSON.stringify(loc)));
  const getLocationFromStorage = id => JSON.parse(localStorage.getItem(id));
  const getLocationsFromStorage = () => Object.keys(localStorage).map(key => JSON.parse(localStorage.getItem(key)));

  async function fetchAndSaveLocations() {
    localStorage.clear();
    const response = await fetchLocationsPage(1);
    let locations = response.items;
    saveLocationsToStorage(locations);
    for (let i = 2; i <= response.pages; i++) {
      const response = await fetchLocationsPage(i);
      if (response.items.length === 0) break;
      saveLocationsToStorage(response.items);
      locations = locations.concat(response.items);
    }
    return locations;
  }

  // Function to add markers for each location
  function addLocationMarkers(locations) {
    locations.forEach(location => {
      const lat = location.osm_lat;
      const lon = location.osm_lon;
      if (lat && lon) {
        L.marker([lat, lon]).addTo(map).bindPopup(`
            <b>${location.osm_name || "Unknown Location"}</b><br>
            ${location.osm_address_city || ""}${location.osm_address_city && location.osm_address_country ? ", " : ""}${
          location.osm_address_country || ""
        }<br>
            Price Count: ${location.price_count || 0}<br>
            Products: ${location.product_count || 0}<br>
            Type: ${location.type || "Unknown"}
          `);
      }
    });
  }
  // Function to initialize the map
  async function initMap() {
    const locations = getLocationsFromStorage();
    if (locations.length === 0) {
      const locations = await fetchAndSaveLocations();
    }
    addLocationMarkers(locations);
  }
  // Initialize the map
  initMap();
</script>
