<!DOCTYPE html>
<html lang="en">
  <head>
    <base target="_top" />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Open Prices Map</title>

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>

    <style>
      html,
      body {
        height: 100%;
        margin: 0;
      }

      .leaflet-container {
        height: 100%;
        width: 100%;
        max-width: 100%;
        max-height: 100%;
      }
    </style>
  </head>

  <body>
    <div id="map" style="width: 100%; height: 100%"></div>
  </body>
</html>
<script>
  const osmUrl = "https://tile.openstreetmap.org/{z}/{x}/{y}.png";
  const osmAttribution = '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>';
  const osmTilesOptions = { maxZoom: 19, attribution: osmAttribution };
  const apiUrl = "https://prices.openfoodfacts.org";
  const defaultMapState = { center: [46.22, 6.1], zoom: 13 };

  const fetchLocationsPage = page => fetch(`${apiUrl}/api/v1/locations?page=${page}&size=100`).then(response => response.json());
  const saveLocationsToStorage = locs => locs.forEach(loc => localStorage.setItem(loc.id, JSON.stringify(loc)));
  const getLocationFromStorage = id => JSON.parse(localStorage.getItem(id));
  const getLocationsFromStorage = () => Object.keys(localStorage).map(key => JSON.parse(localStorage.getItem(key)));
  const saveMapState = () => localStorage.setItem("mapState", JSON.stringify({ center: map.getCenter(), zoom: map.getZoom() }));

  const savedMapState = getLocationFromStorage("mapState") || defaultMapState;
  const map = L.map("map").setView(savedMapState.center, savedMapState.zoom);
  const tiles = L.tileLayer(osmUrl, osmTilesOptions).addTo(map);
  const markersLayer = L.layerGroup().addTo(map);

  async function fetchAndSaveLocations() {
    localStorage.clear();
    const response = await fetchLocationsPage(1);
    saveLocationsToStorage(response.items);
    for (let i = 2; i <= response.pages; i++) {
      const response = await fetchLocationsPage(i);
      if (response.items.length === 0) break;
      saveLocationsToStorage(response.items);
    }
  }

  // Function to add markers for locations within current bounds
  function updateMarkers(locations) {
    const bounds = map.getBounds();
    const locationsInBounds = locations.filter(location => {
      const lat = location.osm_lat;
      const lon = location.osm_lon;
      return lat && lon && bounds.contains(L.latLng(lat, lon));
    });
    const markers = locationsInBounds.map(location => {
      const lat = location.osm_lat;
      const lon = location.osm_lon;
      return L.marker([lat, lon]).bindPopup(`
        <b>${location.osm_name || "Unknown Location"}</b><br>
        ${location.osm_address_city || ""}${location.osm_address_city && location.osm_address_country ? ", " : ""}${
        location.osm_address_country || ""
      }<br>
        Price Count: ${location.price_count || 0}<br>
        Products: ${location.product_count || 0}<br>
        Type: ${location.type || "Unknown"}
      `);
    });
    markersLayer.clearLayers();
    L.featureGroup(markers).addTo(markersLayer);
  }

  // Function to initialize the map
  async function main() {
    if (localStorage.length === 0) {
      await fetchAndSaveLocations();
    }
    const locations = getLocationsFromStorage();
    updateMarkers(locations);
    map.on("moveend", () => updateMarkers(locations));
    map.on("moveend", saveMapState);
    map.on("zoomend", () => updateMarkers(locations));
    map.on("zoomend", saveMapState);
  }

  main();
</script>
